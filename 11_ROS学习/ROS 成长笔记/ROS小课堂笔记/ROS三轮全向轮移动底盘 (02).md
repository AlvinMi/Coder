# 三轮全向轮移动底盘的运动学建模分析
## 01  分析之前的假设
移动底盘、建立三轮全向移动底盘的运动学模型之前, 做如下假设 :

* 1.移动底盘全向轮均为刚体, 运动局限在平面上, 只有线速度x, 线速度y, 角速度z;

* 2.全向轮与地面有足够的摩擦力, 没有打滑现象;

* 3.移动底盘重心在电机轴线中心上, 各个全向轮的中心分布在同一圆上;

* 4.全向轮的安装绝对精准, 安装上造成的误差可以忽略不计;

* 5.全向轮的大小构造一致, 其差别可以忽略。

## 02 坐标系分析
在 ROS 中规定了机器人自身的坐标系系统, ROS 中规定 ROS 机器人的 X轴是机器人前方, Y 轴是在机器人的左方, Z 轴朝上; 可以使用右手坐标系表示, 右手表示机器人本体, 食指朝前是 X 轴正方向, 中指朝左是 Y 轴正方向, 拇指朝上是 Z 轴正方向;

对于机器人的旋转坐标系, 大拇指指向 Z 轴, 逆时针方向为正, 顺时针为负。

## 03 应用到底盘
有四种设计

如下图 :

![](http://p2dak62rv.bkt.clouddn.com/2018.3.26_1.png)

XOY 为世界坐标系, xoy 为机器人坐标系; 四种方案都可以实现移动底盘的正常移动, 只不过运动学模型方程不同。

但是考虑到现实使用中, 考虑到全向轮特殊的构造和电机功率的消耗, 各方案效率不同：

* 1.移动底盘的大部分运动, 若以前进、后退运动为主, A、B 方案肯定优于 C、D 方案, 因为 A/B 方案前后移动时只需要两个电机, C/D 方案需要三个电机配合联动才能前进后退。

* 2.移动底盘的大部分运动, 若以左右横向运动为主, 那么 C 方案优于其他 A/B/D 三个方案, 因为横向移动时 C 方案只需要两个电机, 其他三个方案需要三个电机配合联动才能横向移动。

* 3.最奇葩的还是 D 方案, 只有当底盘在特定的移动角度时才优于其他方案, 所以需要根据项目实际情况, 选择适合自己的结构设计才能最高效率方式控制底盘的移动。

* 4.一般大多是以 前后移动为主, 所以刚开始选择最优的方案只能是 A 或者 B 方案, 但是考虑到后期的底盘校准, 如走直线或走曲线运动时的转向问题, **建议** 还是选择 A 方案, 这样怼运动方向的控制会更容易。 当然, 还是应该跟库自己的实际情况考虑而定。

* 5.对于运动学建模和分析, 还需要配合移动底盘的动力学建模和分析才能更彻底的完善整个控制系统。  

## 04 基于 A 方案的运动学建模
如下图 :

![图片截图于ROS小课堂](http://p2dak62rv.bkt.clouddn.com/2018.3.26_2.png)

以 A 方案进行运动学建模分析, 由于有三个轮子, 所以我们需要规定下每个轮子的编号 **A、B、C** 轮, 排列组合下, 总共有 6 种编号的方案。 轮子编号的不同并不影响运动学模型以及后来的运动控制, 现在规定右前轮为 A 轮, 左前轮为 B 轮, 后轮为 C 轮, 进行运功学分析。

## 06 运动学模型
运动学模型分为正运动学模型和逆运动模型, 正逆之分需要看以谁为主体。 若以移动底盘为主体的话 :

* 正运动学模型 : 根据运动规划的线速度 X, Y, 角速度 Z, 得出三轮全向轮各个轮子的线速度, 这是我们移动底盘最需要的, 由于 ROS 会给我们的底盘发送 `geometry_msgs/Twist` 消息格式, 不会给我们发送三个轮子每个轮子的速度, 所以需要我们正向根据运动学模型方程来求解出三个轮子的速度。

* 逆运动学模型 : 根据三个轮子各个的运动速度, 我们可以合成移动底盘整体的运动线速度 X, Y, 角速度 θ; 主要应用在使用测程法(odomertry)时, 我们需要测量每个轮子的编码器脉冲数来计算轮子的转速, 最终得到三个轮子线速度, 根据逆运动学模型方程求解出移动底盘整体的线速度 X, Y, 角速度 Z。

如下图所示 :

![图片截图于ROS小课堂](http://p2dak62rv.bkt.clouddn.com/2018.3.26_3.png)

## 07 运动学模型方程组推导
规定 XOY 为世界坐标系, xoy 为移动底盘坐标系, Va, Vb, Vc 为全向轮线速度; La, Lb, Lc 分别为移动底盘中心到三个全向轮与地面接触点之间的距离; Vx, Vy 是底盘的相对于车体中心线速度; θ 为移动底盘自转的角速度, 逆时针为方向。

现在以移动底盘的某一具体位姿态来分析, 即线速度为 Vx, Vy, 自转的角速度 Z 为 θ(正方向运动即逆时针运动), 根据三轮全向移动底盘的运动特性, 平面运动速度分解合成关系, 来依次分析车体三个轮子中心的速度及中心的速度的运动学模型方程。
如下图 :

![三轮底盘分析](http://p2dak62rv.bkt.clouddn.com/2018.3.26_4.png)

## 08 分析 A 轮的运动状态
根据正运动学模型可知, 我们需要将 Vx, Vy速度分解到 Va 上即可得知 A 轮的速度对整个底盘运动的作用。 首先我们现在规定 Vxa 为 Vx 在 Va 上分解后的速度, Vya 为 Vy 在 Va 上分解后的速度, Vθa 为底盘的自转角速度作用在 A 轮上的速度 :

* 1.分解 Vx : 由于 Va 与 Vx 之间的夹角为 α, 所以可得 :

        $Vxa = Vx * cosα$ ;

* 2.分解 Vy : 由于 Vy 与 Va 之间的夹角如图所示可知 α 的位置, 所以可得 :

        $Vya = Vy * sinα$;

* 3.由于底盘自身的角速度为 θ, 那么自转引起的线速度作用在 A 轮上的速度 :

        $Vθα = La*θ$;

* 4.最后根据运动合成合分解可知 :

        $\begin{array}{lll}
        Va &=& Vxa + VYa + Vθα \\
        &=&  Vx*cosα + Vy*sinα + La*θ
        \end{array}$
<!-- $Va = Vxa + VYa + Vθα = Vx*cosα + Vy*sinα + La*θ$。 -->

## 09 分析 B 轮的运动状态
同理, 首先我们现在规定 Vxb 为 Vx 在 Vb 上分解后的速度, Vyb 为 Vy 在 Vb 上分解后的速度, Vθb 为底盘的自转角速度作用在 B 轮上的速度 :

* 1.分解 Vx : 由于 Vx 与 Vb **反向** 之间的夹角为 α , 所以可得 :

        $Vxb = -Vx * cosα$ ;

* 2.分解 Vy : 由于 Vy 与 Vb 之间的夹角如图所示可知 α 的位置, 所以可得 :

        $Vyb = Vy * sinα$;

* 3.由于底盘自身的角速度为 θ, 那么自转引起的线速度作用在 B 轮上的速度 :

        $Vθb = Lb*θ$;

* 4.最后根据运动合成合分解可知 :

        $\begin{array}{lll}
        Vb &=& Vxb + VYb + Vθα  \\
        &=& -Vx*cosα + Vy*sinα + La*θ
        \end{array}$
<!-- $Vb = Vxb + VYb + Vθα  \\ =-Vx*cosα + Vy*sinα + La*θ$ -->

## 10 分析 C 轮的运动状态
由于 Vx 与 Vc 垂直, 所以 Vx 在 Vc 方向上没有分解速度, 同时如图也可以得知,Vy 与 Vc 是反向的, 那么同样先假设 Vyc 为 Vy 在 Vc 上分解的速度, Vθc 为底盘的自转角速度作用在 C 轮上的速度 :

* 1.分解 Vx : 由于 Vx 与 Vc 垂直, 所以可得 :

        $Vxc = 0$;

* 2.分解 Vy : 由于 Vy 与 Vc 是相反的方向, 所以可得 :

        $Vyc = -Vy$;

* 3.由于底盘自身的角速度为 0, 那么自转引起的线速度作用在 C 轮上的速度为 :

        $Vθc = Lc*θ$;

* 4.最后根据运动合成合分解可知 :

      $\begin{array}{lll}
      Vc&=&Vxc + Vyc + Vθc \\
      &=& -Vy +Lc*θ
      \end{array}$

<!-- $ = Vxc + Vyc + Vθc \\= -Vy +Lc*θ$; -->

## 11 得出三轮全向轮的正运动学模型方程组

$\begin{equation}
\left\{
        \begin{array}{lr}
        Vα =  VxCosα + VySinα + Lθ   \\
        Vb = -VxCosα + VySinα + Lθ   \\
        Vc = -Vy + Lθ
        \end{array}
\right.
\end{equation}$   

由于得知 `α = 30°`, 且 La, Lb, Lc 一般都是相同的 L(因为三个轮子到底盘中心的距离一般是相同的), 因此我们带入到方程可知 :

$\begin{equation}
\left\{
        \begin{array}{lr}
        Vα = \frac{\sqrt{3}}2 Vx + \frac{1}2 Vy + Lθ  \  &① \\
        Vb = \frac{-\sqrt{3}}2 Vx + \frac{1}2 Vy + Lθ  \ &②\\
        Vc = -Vy + Lθ &③
        \end{array}
\right.
\end{equation}$

## 12 当 La,Lb,Lc 距离不同
如果是圆形的底盘, 一般是相同的 L, 但是正运动模型方程组其实也赋予我们更大的调整空间, 可以规定 La,Lb,Lc 不相同, 即可以设计成各种奇特形状的底盘。

例如椭圆形底盘结构, 仍然是可以进行运动学模型分析的 : 运动学模型都是一样的过程, 只不过车轮与底盘中心之间的角度, 需要自测。 相对来说麻烦一点。

## 13 对得到的运动型方程组进行简单的验证
进行简单的验证, 看是否与我们预期运动方式相符合。

* 1.当底盘向前运动, 即 Vx = a, Vy = 0, θ = 0 时:

$\begin{equation}
\left\{
        \begin{array}{lr}
        Vα = \frac{\sqrt{3}}2 α  \\
        Vb = \frac{-\sqrt{3}}2 α   \\
        Vc = 0  
        \end{array}
\right.
\end{equation}$

带入方程可见, 只有 A，B 轮有速度, C 轮为 0;

* 2. 当底盘原地以角速度 θ 运动时, 即 Vx = 0, Vy = 0;

$\begin{equation}
\left\{
        \begin{array}{lr}
        Vα = Lθ   \\
        Vb = Lθ   \\
        Vc = Lθ
        \end{array}
\right.
\end{equation}$

## 14 提示
网上有的论文中, 有的论文中提到的三轮全向轮正运动学模型方程组是错误的, 如果使用了错误的运动学模型方程组, 那么移动底盘肯定无法正常的工作。

ROS 小课堂视频教程中有讲, 是以一篇百度上的论文为案例, 指出了作者的错误, 并且进行了纠正。

## 15 逆运动学方程推导过程
正运动学模型方程上面已经计算出来了, 那么逆运动学模型也能计算出来。 我们需要将该方程组作为三元一次方程组, 把 Vx, Vy, θ 作为未知量, 把 Va, Vb, Vc 作为已知量即可, 利用 **消元法** 求解过程 :

$\begin{equation}
\left\{
        \begin{array}{lr}
        Vα = \frac{\sqrt{3}}2 Vx + \frac{1}2 Vy + Lθ  \  &① \\
        Vb = \frac{-\sqrt{3}}2 Vx + \frac{1}2 Vy + Lθ  \ &②\\
        Vc = -Vy + Lθ &③
        \end{array}
\right.
\end{equation}$   

* 1.由 ① + ② 得 :

    $Va + Vb = Vy + 2Lθ$ ④

* 2.由 ③ + ④ 得 :

    $Va+Vb+Vc = 3Lθ$ ;

    $θ = \frac{Va+Vb+Vc}{3L}$  ⑤

* 3.将 ⑤ 代入到 ④ 中, 可以得出 Vy:

      $Vy = \frac{Va+Vb-2*Vc}{3}$ ⑥

* 4.将 ⑤, ⑥ 代入到 ① 中得出 Vx :

      $Vx = \frac{\sqrt{3}(Va+Vb)}{3}$ ⑦

* 5.最终, ⑤、⑥、⑦ 就是我们需要得到的逆运动学方程组 :

逆运动学方程组
$\begin{equation}
\left\{
        \begin{array}{lr}
        θ = \frac{Va+Vb+Vc}{3L}  \  &① \\
        Vy = \frac{Va+Vb-2*Vc}{3} \ &②\\
        Vx = \frac{\sqrt{3}(Va+Vb)}{3} &③
        \end{array}
\right.
\end{equation}$

## 16 对逆运动学方程组进行验证

由于上面的逆方程组, 进行简单的验证, 看方程组是否正确。

当 $Va=Vb=Vc = α$ 时, 可知底盘应该是原地旋转, 代入方程组得 :

$\begin{equation}
\left\{
        \begin{array}{lr}
        Vx = 0\\
        Vy = 0\\
        θ = α/L
        \end{array}
\right.
\end{equation}$

Vx, Vy 线速度为 0, 只有底盘角速度大小为 $α/L$, 与预期相同。

## 17 小结
运动学模型方程组的准确, 在实际中机器人的运动通常都是会有误差存在的, 误差通常分为静态误差、动态误差和随机误差。

因此对于机器人本体参数而言, 轮子的半径, 轮子装配的非对称性(包括电机轴线间的夹角、轮子中心距离车体中心的距离)以及运动过程中由于车体震动造成的轮子与地面间的接触面积不同所带来的不同滚动摩擦力等原因都是将导致运动误差的出现。

所以, 建立良好的机器人运动学模型只是进行机器人控制的最基本一步, 并不是说有了正确的运动学模型方程组我们就完事了, 还需要更多方式完善我们的控制系统才能更接近完美, 后面将会学习对机器人运动特性及其误差做进一步分析。
